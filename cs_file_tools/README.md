# cs_file_tools
Scripts focused on manipulating `.cs` files generated by `cryoSPARC` (https://www.cryosparc.com).

## `export_cs_particle_stack.py`
In cases where you want to avoid re-running CTF estimation & particle extraction to simply check how a particle stack from `cryoSPARC` behaves in `RELION` use this script to generate a stack of particles with a corresponding `.star` metadata file suitable for import in `RELION` (after re-normalization). Here are the key steps:

1. Prepare your `RELION` workspace, e.g.:
```sh 
    $ mkdir RELION_proc_J###
    $ cd RELION_proc_J###  
```

2. Run the export script in the fresh workspace, e.g.:
```sh
    $ export_cs_particle_stack.py  /path/to/J###/J###_###_particles.cs  /path/to/CS/root/folder  --dry-run  
    ## check the resulting output makes sense, then re-run without the --dry-run flag 
```
This will generate a `particles.star` file that points to each particle present in the `mrcs_stacks/` folder in the current working directory. 

3. Re-normalize the particles according to how `RELION` expects it. Typically you use `0.37 * box size` to define the `bg_radius` parameter (i.e. consider the outer 25% of the image as background). For particles extracted with tight boxes, you may want to increase this value to avoid cutting into signal.

4. Import the particles using the `Import` job in `RELION` via the `particles.star` file. 

5. Run a 2D classification or 3D auto-refine (using the `cryoSPARC` volume) to confirm everything went well. 



## `get_particle_locations_from_cs.py`
This script is meant to ease the process of transferring particle locations/coordinates from a cryosparc project to a RELION project where the particles can then be extracted from within RELION and handled internally from there. Here is a rough outline of the steps you will need to take to run this script and hook up its outputs successfully:

1. `Export` your particles with location data attached (via the `Outputs` tab in a finished `cryoSPARC` job). Check the `Event Log` to find where the exported `.cs` file is.
2. Make an empty directory to hold the expected output files and enter that directory for the subsequent step.
3. Run the script against the exported `.cs` file, e.g.:

> /path/to/empty/folder 
> ```sh
>  $ get_particle_locations_from_cs.py  <exported>.cs 
> ```

4. Open your `RELION` project, make a dummy pick, and save the coordinate to generate the necessary directory structure in your target `ManualPick` job.

5. Copy the output files from the script into the same location as the dummy pick was made (look for the `<mic_name>_manualpick.star` file). E.g.:

> /path/to/output/folder 
> ```sh
>  $ cp *star /path/to/RELION/dir/ManualPick/job###/Micrographs/ 
> ```

4. The *content* of each output file will be in a form that is acceptable for a `RELION` 4.0/5.0 `ManualPick` job to parse; however, the individual *filenames* will likely need to be changed to match the expected convention: `<mic_basename>_manualpick.star`. You will likely need to do some `bash` string manipulation to adjust the name, e.g.:

```sh 
 # Here is an example micrograph from cryoSPARC with a UID and extra suffix characters: 
 # 009343540879033988068_FoilHole_28212863_Data_28172543_3_20240229_032341_EER_patch_aligned.mrc 
   
 # We need to change it to match just the raw micrograph name since that is what was imported into RELION plus add the necessary manualpick.star suffix, e.g.:
 # FoilHole_28212863_Data_28172543_3_20240229_032341_EER_manualpick.star
  
 # We can achieve this via the following string manipulation steps: 
 $ mic=009343540879033988068_FoilHole_28212863_Data_28172543_3_20240229_032341_EER_patch_aligned.star
 $ mic2=${mic#*_}; mv $mic ${mic2/_patch_aligned.mrc/}_manualpick.star
 
 # We can hook this manipulation up into a for loop to change all our output files at once:
 $ for m in *star; do m2=${m#*_}; mv $m ${m2/_patch_aligned.mrc/}_manualpick.star; done

 # It is safest to first run the loop with an echo command replacing mv before executing the actual change 
```

5. Open the `ManualPick` job in `RELION` and check your coordinates were properly imported into the micrographs. 